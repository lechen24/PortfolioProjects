--Questions we want to answer:
--Global Numbers.
--Which country has the highest number of cases, the highest number of deaths, and death percentage?
--Percentage of people vacinated in each country.
--Predictive modeling for cases and deaths.
--Rolling period for total number of cases compared to total population.

--Global Numbers
--Incorporated continent IS NOT NULL to avoid duplicate data
SELECT SUM(new_cases) AS TotalCases, 
	SUM(new_deaths) AS TotalDeaths,
	SUM(new_deaths)/SUM(new_cases) * 100 AS DeathPercentage
FROM CovidDeath$
WHERE continent IS NOT NULL 
ORDER BY 1 ASC

--Which country has the highest number of cases, the highest number of deaths, and death percentage?
--Needed CASE for the divide by 0 error when SUM(new_cases) = 0
SELECT location,
	SUM(new_cases) AS TotalCases,
	SUM(new_deaths) AS TotalDeaths,
	CASE 
		WHEN SUM(new_cases) = 0 THEN 0  
		ELSE SUM(new_deaths)/SUM(new_cases) * 100
	END AS DeathPercentage
FROM CovidDeath$
WHERE continent IS NOT NULL
GROUP BY location
ORDER BY TotalCases DESC

SELECT location,
	SUM(new_cases) AS TotalCases,
	SUM(new_deaths) AS TotalDeaths,
	CASE 
		WHEN SUM(new_cases) = 0 THEN 0  
		ELSE SUM(new_deaths)/SUM(new_cases) * 100
	END AS DeathPercentage
FROM CovidDeath$
WHERE continent IS NOT NULL
GROUP BY location
ORDER BY TotalDeaths DESC

SELECT location,
	SUM(new_cases) AS TotalCases,
	SUM(new_deaths) AS TotalDeaths,
	CASE 
		WHEN SUM(new_cases) = 0 THEN 0  
		ELSE SUM(new_deaths)/SUM(new_cases) * 100
	END AS DeathPercentage
FROM CovidDeath$
WHERE continent IS NOT NULL
GROUP BY location
ORDER BY DeathPercentage DESC

--Percentage of people not fully vaccinated in each country.

SELECT d.location,
	d.population,
	MAX(CAST(v.people_fully_vaccinated AS BIGINT)) AS FullyVaccinated,
	CASE 
		WHEN MAX(CAST(v.people_fully_vaccinated AS BIGINT))/d.population * 100 > 100 THEN 0
		ELSE 100 - MAX(CAST(v.people_fully_vaccinated AS BIGINT))/d.population * 100
	END AS PercentNotFullyVaccinated
FROM CovidDeath$ d
JOIN CovidVac$ v
ON d.location = v.location AND d.date = v.date
GROUP BY d.location, d.population
ORDER BY PercentNotFullyVaccinated DESC

--Predictive modeling for cases and deaths.

SELECT date,
	location,
	new_cases
FROM CovidDeath$
WHERE continent IS NOT NULL

--Rolling period for total number of cases compared to total population.

WITH cases_vs_population (location, date, population, new_cases, total_number_cases)
AS (
SELECT v.location,
	v.date,
	d.population,
	d.new_cases,
	SUM(CONVERT(bigint,d.new_cases)) OVER (PARTITION BY d.location ORDER BY d.location,d.date) AS total_number_cases
FROM CovidVac$ v 
JOIN CovidDeath$ d
ON v.location = d.location AND v.date = d.date
WHERE d.continent IS NOT NULL
)
SELECT *, (total_number_cases/population) * 100 AS percent_cases_vs_population
FROM cases_vs_population
ORDER BY 6 DESC
